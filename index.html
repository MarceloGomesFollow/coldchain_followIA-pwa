<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Follow ColdChain Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body { font-family:sans-serif; padding:1rem; }
    #grafico-container { width:100%; height:350px; margin:1rem 0; }
    #graficoGPT { width:100% !important; height:100% !important; }
    #loading { display:none; font-weight:bold; }
  </style>
</head>
<body>
  <h1>ColdChain Analytics</h1>
  <p id="loading">Carregando serviço, aguarde...</p>
  <form id="form" style="display:none;">
    <label>Embarque:<input name="embarque" required></label>
        <label>Relatório de Temperatura (PDF obrigatório):
      <input type="file" name="relatorio_temp" accept="application/pdf" required>
    </label>

    <label>Solicitação de Monitoramento SM (PDF obrigatório):
      <input type="file" name="solicitacao_sm" accept="application/pdf" required>
    </label>

    <label>CTE – Conhecimento de Embarque (opcional; PDF/Excel/CSV/Imagem):
      <input type="file" name="cte"
             accept=".pdf,.xlsx,.xls,.csv,.png,.jpg,.jpeg">
    </label>

    <button type="submit">Analisar</button>
  </form>

  <label>
  <input type="checkbox" name="gerar_grafico">
  Gerar gráfico
</label>

  <div id="output"></div>
  <div id="grafico-container">
    <canvas id="graficoGPT"></canvas>
  </div>

  <script>
    const backend = 'https://coldchain-backend.onrender.com';
    const form    = document.getElementById('form');
    const loadMsg = document.getElementById('loading');
    const ctx     = document.getElementById('graficoGPT').getContext('2d');
    let chart     = null;

    async function warmup() {
      try {
        loadMsg.style.display = 'block';
        const resp = await fetch(`${backend}/health`);
        if (resp.ok) {
          loadMsg.style.display = 'none';
          form.style.display = 'block';
        } else throw 'Healthcheck falhou';
      } catch (err) {
        loadMsg.textContent = 'Erro ao conectar: ' + err;
      }
    }
    warmup();

    form.addEventListener('submit', async e => {
      e.preventDefault();
      document.getElementById('output').textContent = 'Analisando...';
      try {
        const res = await fetch(`${backend}/analisar`, {
          method: 'POST', body: new FormData(form)
        });
        if (!res.ok) {
          const txt = await res.text();
          throw txt;
        }
        const j = await res.json();
        document.getElementById('output').innerHTML = marked.parse(j.report_md);

        const ds      = j.grafico.datasets;
        const xLabels = ds.find(d=>d.type==='scatter').data.map(pt=>pt.x);
        const cfg     = {
          data: { datasets: ds },
          options: {
            parsing: { xAxisKey:'x', yAxisKey:'y' },
            scales: {
              x: { type:'category', labels:xLabels, ticks:{autoSkip:true,maxTicksLimit:15} },
              y: {}
            },
            responsive:true,maintainAspectRatio:false
          }
        };
        if (chart) chart.destroy();
        chart = new Chart(ctx, cfg);
      } catch (err) {
        document.getElementById('output').textContent = 'Erro: ' + err;
        console.error('Analisar falhou:', err);
      }
    });
  </script>
</body>
</html>
